<html>

<head>

    <script src="d3.js" ></script>

</head>

<body>

    <h1>Busses and Lines</h1>
    <div>
        <p>Hello, world! </p>
        <svg id="map"></svg>
    </div>

</body>

<script type="module">
    import {text} from "https://cdn.skypack.dev/d3-fetch@3";
    let data = {}

    function loadData() {
        return Promise.all([
            d3.json("data/geojsons/bay.geo.json"),
            text('data/p13uhs0_1247/DSSfiles/Buscoords.dss'),
            text('data/p13uhs0_1247/DSSfiles/Lines.dss'),
        ]).then(resps => {
            data.zips = resps[0];
            data.busStr = resps[1];
            data.lineStr = resps[2];
            return data
        })
    }

    function parseData() {
        parseBusData()
        parseLineData()
    }

    function parseBusData() {
        // initialize geoJSON object for storing output of function
        let busObj = {
            "type": "FeatureCollection",
            "features": []
        };  

        // split up bus text into an array
        let busArray = data.busStr.split('\n'); // get each bus with newline element
        let busArrayFilt = busArray.filter(b => b.length) // filter blank lines
        let busArraySplit = busArrayFilt.map(bus => bus.split(' ')) // split each bus into name and coords
        // convert array into a geoJSON
        busArraySplit.forEach(element => {
            let busName = element[0]
            let busLong = +element[1]
            let busLat = +element[2]
            busObj["features"].push({
                "type": "Feature",
                "properties": {
                    "name": busName
                },
                "geometry": {
                    "type": "Point",
                    "coordinates": [busLong, busLat]
                }
            })
        });
        data.busObj = busObj
        return busObj
    }

    function parseLineData() {
        let lineObj = {
            "type": "FeatureCollection",
            "features": []
        }

        let lineArray = data.lineStr.split('\n');
        let lineArrayFilt = lineArray.filter(l => l.length) // filter blank lines
        let lineArraySplit = lineArrayFilt.map(l => l.split(' '))
        console.log(lineArraySplit)

        lineArraySplit.forEach(l => {
            lineObj["features"].push({
                "type": "Feature",
                "properties": {
                    "name": l[1], 
                    "bus1": l[4],
                    "bus2": l[5]
                    // todo add in other line elements
                    
                },
                "geometry": {
                    "type": "linestring",
                    "coordinates": [["x1","y1"],["x2","y2"]]
                    // todo figure out how match up busses and
                    // extract coordinates
                    
                }
            })
        })
        data.lineObj = lineObj
        return lineObj
    }

    function showData() {
        drawMap(data.zips)
        drawBusses(data.busObj)
        return
    }

    function getMapConfig(){
        let width = 600;
        let height = 600;
        let container = d3.select("#map")
            .attr("height", height)
            .attr("width", width)
        return {width, height, container}
    }

    function getMapProjection(config) {
        let {width, height} = config;
        let projection = d3.geoMercator()
        let s0 = 10240
        let x0 = 21879
        let y0 = 7351
        let m = 70
        let b = 22
        let s = m * s0
        let x = m * (x0 - b)
        let y = m * (y0 - b)

        projection.scale(s).translate([x, y])
                    
        data.mapProjection = projection;
        return projection;
    }

    function drawBaseMap(container, zips, projection) {
        let path = d3.geoPath().projection(projection);

        container.selectAll("path")
            .data(zips)
            .enter()
            .append("path")
            .attr("d", d => path(d)) 
            .attr("stroke", "#ccc")
            .attr("fill", "#eee")
    }

    function addZoom() {
        let zoom = d3.zoom().on('zoom', handleZoom);
        function handleZoom(e) {
            d3.select('#map')
                .attr('transform', e.transform);
        }
        d3.select('#map').call(zoom)
    }

    function drawMap(geoJson) {
        let config = getMapConfig();
        let projection = getMapProjection(config);
        drawBaseMap(config.container, geoJson.features, projection)
        addZoom()
    }

    function drawBusses(busses) {
        let config = getMapConfig();
        let projection = getMapProjection(config);
        let container = config.container;
        let circles = container.selectAll("circle")
            .data(busses.features)
            .enter()
            .append("circle")
            .attr("r", 0.8)
            .attr("cx", d => projection([d.geometry.coordinates[0], d.geometry.coordinates[1]])[0])
            .attr("cy", d => projection([d.geometry.coordinates[0], d.geometry.coordinates[1]])[1])
            .attr("fill", "#2a5599")
    }

    

    loadData().then(parseData).then(showData).then(console.log("All Data: ", data))
    
</script>

</html>