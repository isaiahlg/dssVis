<html>

<head>

    <script src="d3.js" ></script>

</head>

<body>

    <h1>Busses and Lines</h1>
    <div>
        <p>Hello, world! </p>
        <svg id="map"></svg>
    </div>

</body>

<script type="module">
    import {text} from "https://cdn.skypack.dev/d3-fetch@3";
    let data = {}

    function loadData() {
        return Promise.all([
            text('data/p13uhs0_1247/DSSfiles/Buscoords.dss'),
            d3.json("data/bay.geo.json"),
        ]).then(resps => {
            data.busStr = resps[0]
            data.countries = resps[1];
            return data
        })
    }

    function parseData() {
        // initialize geoJSON object for storing output of function
        let busObj = {
            "type": "FeatureCollection",
            "features": []
        };  

        // split up bus text into an array
        let busArray = data.busStr.split('\n'); // get each bus with newline element
        let busSplitArray = busArray.map(bus => bus.split(' ')) // split each bus into name and coords
        // convert array into a geoJSON
        busSplitArray.forEach(element => {
            if (!element[0]) {return} // skip empty lines of text to avoid errors later
            let busName = element[0]
            let busLong = +element[1]
            let busLat = +element[2]
            busObj["features"].push({
                "type": "Feature",
                "properties": {
                    "name": busName
                },
                "geometry": {
                    "type": "Point",
                    "coordinates": [busLong, busLat]
                }
            })
        });
        data.busObj = busObj
        return busObj
    }

    function showData() {
        drawMap(data.countries)
        drawBusses(data.busObj)
        return
    }

    function getMapConfig(){
        let width = 600;
        let height = 600;
        let container = d3.select("#map")
            .attr("height", height)
            .attr("width", width)
        return {width, height, container}
    }

    function getMapProjection(config) {
        let {width, height} = config;
        let projection = d3.geoMercator()
        // projection.scale(1).translate([width/2, height/2])
        let a0 = [102400, 218800, 735000]
        let s0 = 10240
        let x0 = 21879
        let y0 = 7351
        let f = 70
        let b = 22
        let s = f * s0
        let x = f * (x0 - b)
        let y = f * (y0 - b)

        projection.scale(s).translate([x, y])
                    
        data.mapProjection = projection;
        return projection;
    }

    function drawBaseMap(container, countries, projection) {
        let path = d3.geoPath().projection(projection);

        container.selectAll("path")
            .data(countries)
            .enter()
            .append("path")
            .attr("d", d => path(d)) 
            .attr("stroke", "#ccc")
            .attr("fill", "#eee")
    }

    function drawMap(geoJson) {
        let config = getMapConfig();
        let projection = getMapProjection(config);
        drawBaseMap(config.container, geoJson.features, projection)
    }

    function drawBusses(busses) {
        let config = getMapConfig();
        let projection = getMapProjection(config);
        let container = config.container;
        let circles = container.selectAll("circle")
            .data(busses.features)
            .enter()
            .append("circle")
            .attr("r", 0.8)
            .attr("cx", d => projection([d.geometry.coordinates[0], d.geometry.coordinates[1]])[0])
            .attr("cy", d => projection([d.geometry.coordinates[0], d.geometry.coordinates[1]])[1])
            .attr("fill", "#2a5599")
    }

    let zoom = d3.zoom().on('zoom', handleZoom);
    function handleZoom(e) {
        d3.select('#map')
            .attr('transform', e.transform);
    }
    d3.select('#map').call(zoom)

    loadData().then(parseData).then(showData).then(console.log(data))
    
</script>

</html>